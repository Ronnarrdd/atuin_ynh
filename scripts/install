#!/bin/bash
#=================================================
# YunoHost install script for Atuin server
#=================================================
set -euo pipefail

source /usr/share/yunohost/helpers

app="${YNH_APP_INSTANCE_NAME:-atuin}"

#=================================================
# Figure out app source directory (scripts/..)
#=================================================
script_dir="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"
app_dir="$(cd "$script_dir/.." && pwd)"
conf_dir="$app_dir/conf"

#=================================================
# LOAD SETTINGS / RESOURCES
#=================================================
domain="$(ynh_app_setting_get --app="$app" --key=domain)"
path="$(ynh_app_setting_get --app="$app" --key=path)"
install_dir="$(ynh_app_setting_get --app="$app" --key=install_dir)"
data_dir="$(ynh_app_setting_get --app="$app" --key=data_dir)"
port="$(ynh_app_setting_get --app="$app" --key=port)"

app_user="$app"
app_group="$app"

if [[ -z "${domain:-}" ]]; then
  ynh_die --message="Domain setting is missing (key=domain)."
fi
if [[ -z "${path:-}" ]]; then
  path="/"
fi

#=================================================
# HELPERS
#=================================================
render_template() {
  local src="$1"
  local dest="$2"

  if [[ ! -f "$src" ]]; then
    ynh_die --message="Missing template: $src"
  fi

  cp -f "$src" "$dest"

  # Common placeholders we use in our templates
  sed -i "s#__APP__#${app}#g" "$dest"
  sed -i "s#__INSTALL_DIR__#${install_dir}#g" "$dest"
  sed -i "s#__DATA_DIR__#${data_dir}#g" "$dest"
  sed -i "s#__PORT__#${port}#g" "$dest"
}

#=================================================
# DEPLOY ATUIN BINARY
#=================================================
ynh_script_progression --message="Deploying Atuin binary…" --weight=10

tmp_src="$(mktemp -d)"
ynh_setup_source --dest_dir="$tmp_src"

if [[ ! -f "$tmp_src/atuin" ]]; then
  ynh_die --message="Atuin binary not found in extracted source. Expected: $tmp_src/atuin"
fi

install -Dm755 "$tmp_src/atuin" "$install_dir/atuin"
rm -rf "$tmp_src"

#=================================================
# CONFIGURE DATA DIR + CONFIG FILES
#=================================================
ynh_script_progression --message="Configuring Atuin server…" --weight=25

chown -R "$app_user:$app_group" "$data_dir"
chmod 750 "$data_dir"

db_path="$data_dir/atuin.sqlite"
config_path="$data_dir/config.toml"
env_path="$data_dir/atuin.env"

# config.toml from conf/config.toml
render_template "$conf_dir/config.toml" "$config_path"

# atuin.env (log settings)
cat > "$env_path" <<EOF
# Autogenerated by YunoHost during install
# Change values here and restart the service: systemctl restart atuin

ATUIN_HOST=127.0.0.1
ATUIN_PORT=${port}
ATUIN_DB_URI=sqlite:///${data_dir}/atuin.sqlite
ATUIN_OPEN_REGISTRATION=false

RUST_LOG=info,atuin=debug,atuin_server=debug,tower_http=info
RUST_BACKTRACE=1
EOF

chown "$app_user:$app_group" "$config_path" "$env_path"
chmod 640 "$config_path" "$env_path"

# Pre-create SQLite DB file for correct permissions
touch "$db_path"
chown "$app_user:$app_group" "$db_path"
chmod 640 "$db_path"

#=================================================
# SYSTEMD SERVICE (manual install, because ynh_add_systemd_config is unavailable)
#=================================================
ynh_script_progression --message="Installing systemd service…" --weight=25

systemd_unit="/etc/systemd/system/${app}.service"
render_template "$conf_dir/atuin.service" "$systemd_unit"
chmod 644 "$systemd_unit"

systemctl daemon-reload
systemctl enable "$app"
systemctl restart "$app"

#=================================================
# NGINX REVERSE PROXY (manual install, because ynh_add_nginx_config may be unavailable)
#=================================================
ynh_script_progression --message="Configuring NGINX reverse proxy…" --weight=20

nginx_dir="/etc/nginx/conf.d/${domain}.d"
nginx_conf="${nginx_dir}/${app}.conf"
mkdir -p "$nginx_dir"

render_template "$conf_dir/nginx.conf" "$nginx_conf"
chmod 644 "$nginx_conf"

nginx -t
systemctl reload nginx

#=================================================
# END
#=================================================
ynh_script_progression --message="Installation of $app completed." --last

